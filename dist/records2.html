<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="dashboard.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/remixicon@2.5.0/fonts/remixicon.css" rel="stylesheet">
  <title>FloodFlow</title>
  <link rel="icon" type="image" href="trans.png" />
</head>

<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/dt/dt-1.10.25/datatables.min.css" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<body class="body">

    <section class="header">
        <div class="logo">
            <i class="ri-menu-line menu"></i>
            <h2><span>Flood</span>Flow</h2>
        </div>
        <div class="header--items">
                <div class="dark--theme--btn">
                <i class="ri-moon-line moon"></i>
                <i class="ri-sun-line sun"></i>
            </div>
        </div>
    </section>
    <section class="main">
        <div class="sidebar">
            <ul class="sidebar--items">
                <li>
                    <a href="records.html">
                        <span class="icon"><i class="ri-bar-chart-line"></i></span>
                        <div class="sidebar--item">Data Analytics</div>
                    </a>
                </li>
                <li>
                    <a href="#" class="active">
                        <span class="icon"><i class="ri-handbag-line"></i></span>
                        <div class="sidebar--item">Records</div>
                    </a>
                </li>
                <li>
                    <a href="#">
                        <span class="icon"><i class="ri-user-line"></i></span>
                        <div class="sidebar--item">Administrators</div>
                    </a>
                </li>
                <li>
                    <a href="#">
                        <span class="icon"><i class="ri-settings-3-line"></i></span>
                        <div class="sidebar--item">Settings</div>
                    </a>
                </li>
            </ul>
            <ul class="sidebar--bottom--items">
                <li>
                    <a href="#">
                        <span class="icon"><i class="ri-logout-box-r-line"></i></span>
                        <div class="sidebar--item" id="logout">Logout</div>
                    </a>
                </li>
            </ul>
        </div>
        <!-------main-->
        <div class="main--container">
        <table id="myTable" class="display">
            <thead>
              <tr>
                <th>No. </th>
                <th>Water Level </th>
                <th>Status</th>
                <th>Date Time</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
            </tbody>
          </table>
        </table>
             
              
        </div>
    </section>
    <script src="https://cdn.jsdelivr.net/npm/chart.js/dist/chart.umd.min.js"></script>
    <script src="https://cdn.datatables.net/v/dt/dt-1.10.25/datatables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>

    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDCZAR5sLXy_H2bwkwSAJ0g2lgiR0MuwlI",
            authDomain: "ababonbabantocs2.firebaseapp.com",
            projectId: "ababonbabantocs2",
            storageBucket: "ababonbabantocs2.appspot.com",
            messagingSenderId: "404747337011",
            appId: "1:404747337011:web:767c832524de2971901246",
            measurementId: "G-KSWRBVNXQW"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = app.firestore();

        let body = document.querySelector(".body");
        let sun = document.querySelector(".sun");
        let moon = document.querySelector(".moon");

        moon.onclick = function(){
            body.classList.add("dark--mode");
        };

        sun.onclick = function(){
            body.classList.remove("dark--mode");
        };

        let menu = document.querySelector(".menu");
        let sidebar = document.querySelector(".sidebar");
        let mainContainer = document.querySelector(".main--container");

        menu.onclick = function(){
            sidebar.classList.toggle("activemenu");
        };

        mainContainer.onclick = function(){
            sidebar.classList.remove("activemenu");
        };

        //DataTables
        const table = $('#myTable').DataTable({
            "lengthMenu": [[5, 15, 30, -1], [5, 15, 30, "All"]]
        });

        const query = db.collection("FloodFlow").orderBy("DateTime", "desc");

        query.onSnapshot((snapshot) => {
            table.clear();
            let counter = 1;
            snapshot.forEach((doc) => {
                const data = doc.data();
                const waterLevel = data["Water Level"];
                const status = data["Status"];
                const dateTime = data["DateTime"];
                const formattedDateTime = dateTime.toDate().toLocaleString();

                // Delete Button
                const deleteButton = `<button type="button" class="btn btn-danger btn-sm delete" data-id="${doc.id}-delete"><ion-icon name="trash-outline"></ion-icon></button>`;

                $(document).on('click', '.delete', function () {
                    if ($(this).data('id') === `${doc.id}-delete`) {
                        Swal.fire({
                            title: "Are you sure?",
                            text: `Do you really want to delete the record for ${counter}?`,
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonColor: '#d33',
                            cancelButtonColor: '#3085d6',
                            confirmButtonText: 'Yes, delete it!'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                doc.ref.delete().then(() => {
                                    console.log("Successful Delete");
                                    Swal.fire({
                                        title: "Deleted!",
                                        text: `The record for ${counter} has been deleted`,
                                        icon: "success",
                                    });
                                    table.row($(this).closest('tr')).remove().draw();
                                }).catch((error) => {
                                    console.error("Error removing record: ", error);
                                    Swal.fire({
                                        title: "Error",
                                        text: "There was an error removing the record.",
                                        icon: "error",
                                    });
                                });
                            }
                        });
                    }
                });

                table.row.add([
                    counter++,
                    waterLevel,
                    status,
                    formattedDateTime,
                    deleteButton
                ]);
            });
            table.draw();
        });

        // Logout code start	  
        document.getElementById("logout").addEventListener("click", function() {
            firebase.auth().signOut().then(() => {
                console.log('Sign-out successful.');
                alert('logged out successfully');
                setTimeout(function(){
                    window.location.href = "index.html";
                }, 2000);
            }).catch((error) => {
                console.log('An error happened.');
            });		  		  
        });
    </script>
</body>
</html>
